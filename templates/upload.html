{% extends "base.html" %} {% block title %}Upload{% endblock %} {% block
content%}
<br />
<h1 class="navbar-brand sign-up-heading">Upload Scan</h1>
<p class="nav-item px-1" style="color: white !important; text-align: center">
  New to GeoRepair?
  <a href="/signup" style="color: #4e7e7e; text-decoration: none"
    >Create an account here!</a
  >
</p>
<div
  id="uploadForm"
  class="sign-up-wrapper"
  style="margin: auto; text-align: center; width: 50%"
>
  <form enctype="multipart/form-data" @submit="formSubmit" class="sign-up-grad">
    <span class="text-wrapper">
      <input
        type="text"
        v-model="title"
        placeholder="Title"
        class="text-input"
        size="32"
        required
      />
      <span class="text-border"></span>
    </span>
    <br />
    <span class="text-wrapper"
      ><input
        class="text-input"
        placeholder="Description"
        type="text"
        v-model="des"
    /></span>
    <br />
    <label>Latitude</label>
    <input type="number" v-model="lat" />
    <label>Longitude</label>
    <input type="number" v-model="long" />
    <br />
    <label>Urgency</label>
    <input type="number" v-model="urgency" />
    <br />
    <input type="file" id="file" accept="image/*" />
    <br />
    <input
      class="btn nav-button flask-buttonrect sign-up-btn"
      id="submit"
      name="submit"
      style="margin: auto !important"
      type="submit"
      value="Submit"
    />
  </form>
</div>
<h1 class="formsubmit"></h1>

{% endblock %} {% block scripts %}
<script src="https://unpkg.com/vue@2.6.14/dist/vue.min.js"></script>

<script type="text/javascript">
  var app = new Vue({
    el: "#uploadForm",
    delimiters: ["[[", "]]"],
    data() {
      return {
        title: "",
        des: "",
        long: "",
        lat: "",
        urgency: "",
      };
    },
    methods: {
      formSubmit(e) {
        var datasubmit = {
          title: this.title,
          des: this.des,
          filename: undefined,
          position: [this.lat, this.long],
          urgency: parseInt(this.urgency, 10),
        };
        e.preventDefault();
        var formdata = new FormData();
        var imagefile = document.querySelector("#file");
        formdata.append("image", imagefile.files[0]);
        function postImage(callback) {
          $.ajax({
            type: "POST",
            url: "/api/scans/upload",
            data: formdata,
            contentType: false,
            processData: false,
            success: callback,
          });
        }
        function postData(result) {
          datasubmit["filename"] = result.filename;
          $.ajax({
            type: "POST",
            url: "/api/scans/add",
            data: JSON.stringify(datasubmit),
            contentType: "application/json",
            dataType: "json",
            success: (data) => {
              $(".formsubmit").text("Scan successfully uploaded.");
            },
            error: () => {
              $("form").text("Invalid coordinates. Try again.");
            },
          });
        }
        postImage(postData);
      },
    },
  });
</script>
{% endblock %}
