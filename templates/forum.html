{% extends "base.html" %}
{% block title %}Forum{% endblock %}

{% block content %}
    <div id="vue-app">
		<div v-for="scan in repairs">
			<div class="card" class="col-12">
				<div class="card-body">
					<!-- <h3 class="card-title">[[ scan.title ]]</h3>
					<p class="card-title">[[ scan.upvote ]] upvotes</p>
					<hr>
					<p class="card-text">[[ scan.description ]]</p>
					<p class="card-text"><i>Location: [[ scan.city ]], [[ scan.state ]]</i></p> -->
					<div class="row">
						<div class="col">
							<div>
								<h1>[[ scan.title ]]</h1>
								<h2>posted by [[ scan.post_user ]]</h2>
								<div class="scan-details">
									<div>
										<img src="../static/images/scandate.svg">
										<p>[[ scan.scandate ]]</p>
									</div>
								</div>
								<div class="scan-details">
									<div>
										<img src="../static/images/location.svg">
										<p>[[ scan.city]], [[ scan.state ]]</p>
									</div>
								</div>
							</div>
						</div>
						<div class="col">
							<div>
								<button @click="vote(scan.filename, scan.id)" v-if="'{{ session['logged_in'] }}' == 'True'">
									<img src="../static/images/upvote.svg" v-if="scan.user_list.includes('{{ session['logged_in_id'] }}')">
									<img src="../static/images/unvote.svg" style="transform: rotate(180deg)" v-else>
								</button>
								<a v-else href="/login">
									<button>
										<img src="../static/images/unvote.svg" style="transform: rotate(180deg);">
									</button>
								</a>
								<p v-if="scan.upvote == 1">[[ scan.upvote ]] upvote</p>
								<p v-else>[[ scan.upvote ]] upvotes</p>
							</div>
						</div>
					</div>
					
				</div>
			</div>
		</div>
	</div>
{% endblock %}

{% block scripts %}
	<script type="text/javascript">
		var app = new Vue({
			el: "#vue-app",
			delimiters: ['[[',']]'],
			data() {
				return {
					repairs: []
				};
			},
			methods: {
				getCurrent: function () {
					navigator.geolocation.getCurrentPosition(function(pos) {
						$.ajax({
							type: 'POST',
							url: '/api/scans/all',
							data: JSON.stringify({"position": [pos.coords.latitude, pos.coords.longitude], "range": 100}),
							contentType: "application/json",
							dataType: "json",
							success: function(data) {
								app.repairs = data.repairs;
							}
						});
					});
				},
				vote: function(index, id) {
					$.ajax({
						type: 'POST',
						url: '/api/vote/voting',
						data: JSON.stringify({"name": index, "scan_id": id}),
						contentType: "application/json",
						dataType: "json",
						success: function(data) {
							app.getCurrent();
						}
					});
				}
			}
		});

		app.getCurrent();
		setInterval(app.getCurrent, 1000);
    </script>
{% endblock %}